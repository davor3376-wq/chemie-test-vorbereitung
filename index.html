<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Chemie Masterclass | 2BK Vorbereitung</title>
    <meta name="description" content="Premium Lernplattform f√ºr Chemie 2BK. Atommodell, Bindungen, Redox, St√∂chiometrie.">
    
    <!-- 
    PREMIUM CHEMIE LERNPLATTFORM (SINGLE FILE)
    
    Architektur:
    - Vanilla JS (ES6+) f√ºr maximale Performance und Zero-Dependencies.
    - CSS Variables f√ºr Theming.
    - LocalStorage f√ºr Fortschrittsspeicherung.
    - Modulare Struktur im JS (View-Controller-Pattern).
    
    Inhalte basierend auf Uploads:
    - Atomaufbau, Elektronenkonfiguration
    - Bindungsarten
    - Elektronegativit√§t
    - Redox (Teilgleichungsmethode)
    
    Author: Gemini (Google AI)
    Target Date: 14.01.2026 Test
    -->

    <style>
        /* --- CORE VARIABLES & RESET --- */
        :root {
            --primary: #0b3d91; /* Marineblau */
            --primary-light: #3a6ea5;
            --primary-dark: #001f5c;
            --accent: #ffb703; /* Warmes Gelb f√ºr Hinweise */
            --success: #2a9d8f; /* Erfolg */
            --error: #e63946; /* Fehler */
            --bg-body: #f4f7f6;
            --bg-card: #ffffff;
            --text-main: #1d3557;
            --text-muted: #6c757d;
            --shadow-sm: 0 2px 4px rgba(0,0,0,0.05);
            --shadow-md: 0 4px 12px rgba(11, 61, 145, 0.1);
            --shadow-lg: 0 8px 24px rgba(11, 61, 145, 0.15);
            --radius-md: 12px;
            --radius-lg: 20px;
            --font-main: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; padding: 0; font-family: var(--font-main); background: var(--bg-body); color: var(--text-main); line-height: 1.6; padding-bottom: 80px; }
        
        /* --- TYPOGRAPHY --- */
        h1, h2, h3 { color: var(--primary); margin-top: 0; font-weight: 700; }
        h1 { font-size: 1.8rem; letter-spacing: -0.5px; }
        h2 { font-size: 1.4rem; margin-bottom: 1rem; }
        p { margin-bottom: 1rem; font-size: 1rem; }
        .text-sm { font-size: 0.85rem; color: var(--text-muted); }
        .text-center { text-align: center; }
        .font-mono { font-family: 'SF Mono', 'Monaco', 'Inconsolata', monospace; }

        /* --- LAYOUT COMPONENTS --- */
        .app-container { max-width: 900px; margin: 0 auto; padding: 20px; }
        
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 1px solid rgba(0,0,0,0.05); }
        .logo { font-size: 1.5rem; font-weight: 800; color: var(--primary); display: flex; align-items: center; gap: 10px; }
        .logo span { background: var(--primary); color: white; padding: 4px 10px; border-radius: 8px; font-size: 1rem; }
        
        .card { background: var(--bg-card); border-radius: var(--radius-md); padding: 24px; margin-bottom: 20px; box-shadow: var(--shadow-sm); transition: var(--transition); border: 1px solid transparent; }
        .card:hover { box-shadow: var(--shadow-md); transform: translateY(-2px); }
        .card.active { border-color: var(--primary); }

        /* --- BUTTONS & INTERACTION --- */
        .btn { display: inline-flex; align-items: center; justify-content: center; gap: 8px; background: var(--primary); color: white; border: none; padding: 12px 24px; border-radius: 50px; font-weight: 600; cursor: pointer; transition: var(--transition); font-size: 1rem; text-decoration: none; }
        .btn:hover { background: var(--primary-light); transform: scale(1.02); box-shadow: 0 4px 12px rgba(11, 61, 145, 0.3); }
        .btn:active { transform: scale(0.98); }
        .btn-outline { background: transparent; border: 2px solid var(--primary); color: var(--primary); }
        .btn-outline:hover { background: rgba(11, 61, 145, 0.05); }
        .btn-sm { padding: 8px 16px; font-size: 0.85rem; }
        .btn-ghost { background: transparent; color: var(--text-muted); }
        .btn-ghost:hover { background: rgba(0,0,0,0.05); color: var(--text-main); }

        /* --- DASHBOARD --- */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 16px; margin-bottom: 30px; }
        .stat-card { background: white; padding: 16px; border-radius: var(--radius-md); text-align: center; box-shadow: var(--shadow-sm); border-top: 4px solid var(--primary); }
        .stat-value { font-size: 2rem; font-weight: 800; color: var(--primary); display: block; }
        .stat-label { font-size: 0.8rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; }

        .module-list { display: grid; gap: 16px; }
        .module-item { display: flex; align-items: center; justify-content: space-between; padding: 20px; cursor: pointer; position: relative; overflow: hidden; }
        .module-item::before { content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 6px; background: #eee; }
        .module-item.unlocked::before { background: var(--primary); }
        .module-item.completed::before { background: var(--success); }
        .module-info h3 { margin: 0 0 4px 0; font-size: 1.1rem; }
        .module-progress { height: 4px; background: #eee; width: 100px; border-radius: 2px; overflow: hidden; margin-top: 8px; }
        .module-bar { height: 100%; background: var(--success); width: 0%; transition: width 1s ease; }

        /* --- LEARNING INTERFACE --- */
        .lesson-container { display: none; animation: slideUp 0.4s ease; }
        .lesson-container.active { display: block; }
        .progress-header { margin-bottom: 20px; display: flex; align-items: center; gap: 10px; }
        .progress-dots { display: flex; gap: 6px; flex: 1; }
        .dot { height: 6px; flex: 1; background: #eee; border-radius: 3px; transition: var(--transition); }
        .dot.active { background: var(--primary); }
        .dot.completed { background: var(--success); }

        /* --- INTERACTIVE TOOLS --- */
        .periodic-table-mini { display: grid; grid-template-columns: repeat(8, 1fr); gap: 4px; margin: 20px 0; }
        .element-btn { aspect-ratio: 1; border: 1px solid #ddd; border-radius: 4px; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 0.8rem; cursor: pointer; transition: var(--transition); background: white; }
        .element-btn:hover { border-color: var(--primary); background: #f0f4f8; }
        .element-btn.selected { background: var(--primary); color: white; border-color: var(--primary); }
        
        .redox-step { background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 10px; border-left: 3px solid var(--accent); }
        .formula-input { font-family: var(--font-mono); font-size: 1.2rem; padding: 10px; width: 100%; border: 2px solid #ddd; border-radius: 8px; margin: 10px 0; }
        .formula-input:focus { border-color: var(--primary); outline: none; }

        .chem-equation { display: flex; flex-wrap: wrap; align-items: center; gap: 8px; font-size: 1.1rem; justify-content: center; background: #fff; padding: 15px; border-radius: 8px; border: 1px solid #eee; margin: 10px 0; }
        .chem-part { padding: 4px 8px; background: #f0f4f8; border-radius: 4px; }
        .ox-num { color: var(--error); font-size: 0.75rem; font-weight: bold; position: relative; top: -10px; margin-bottom: -10px; display: block; text-align: center; }

        /* --- FEEDBACK & COACH --- */
        .coach-msg { display: flex; gap: 15px; background: #eef4ff; padding: 16px; border-radius: var(--radius-md); margin-bottom: 20px; align-items: flex-start; }
        .coach-avatar { width: 50px; height: 50px; background: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; color: white; flex-shrink: 0; }
        
        .feedback-toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%) translateY(100px); background: #333; color: white; padding: 12px 24px; border-radius: 50px; box-shadow: var(--shadow-lg); opacity: 0; transition: var(--transition); z-index: 1000; display: flex; align-items: center; gap: 10px; }
        .feedback-toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
        .feedback-toast.success { background: var(--success); }
        .feedback-toast.error { background: var(--error); }

        /* --- NAVIGATION --- */
        .nav-bar { position: fixed; bottom: 0; left: 0; right: 0; background: white; padding: 12px; display: flex; justify-content: space-around; box-shadow: 0 -2px 10px rgba(0,0,0,0.05); z-index: 100; }
        .nav-item { display: flex; flex-direction: column; align-items: center; color: var(--text-muted); font-size: 0.75rem; cursor: pointer; transition: var(--transition); gap: 4px; }
        .nav-item.active { color: var(--primary); }
        .nav-icon { font-size: 1.4rem; }

        /* --- ANIMATIONS --- */
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
        
        /* --- PRINT --- */
        @media print {
            .no-print, .nav-bar, .btn, .progress-header { display: none !important; }
            body { padding: 0; background: white; color: black; }
            .card { box-shadow: none; border: 1px solid #ccc; break-inside: avoid; }
            .app-container { max-width: 100%; padding: 0; }
            .print-only { display: block !important; }
            h1 { font-size: 24pt; color: black; }
        }
        .print-only { display: none; }

        /* --- UTILS --- */
        .hidden { display: none !important; }
        .subscript { vertical-align: sub; font-size: 0.7em; }
        .superscript { vertical-align: super; font-size: 0.7em; }
    </style>
</head>
<body>

<!-- PRINT HEADER (Hidden on screen) -->
<div class="print-only" style="padding: 20px;">
    <h1>Chemie Spickzettel - 2BK</h1>
    <p>Test am 14.01.2026 | Zusammenfassung</p>
    <hr>
</div>

<!-- APP CONTAINER -->
<div id="app" class="app-container">
    
    <!-- ONBOARDING (Overlay) -->
    <div id="onboarding" class="hidden" style="position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(255,255,255,0.95); z-index:2000; padding:40px; text-align:center; display:flex; flex-direction:column; justify-content:center; align-items:center;">
        <div style="font-size:60px; margin-bottom:20px;">üß™</div>
        <h1>Willkommen im Chemie-Coach!</h1>
        <p style="max-width:500px; margin:0 auto 30px;">Deine premium Vorbereitung auf den Test am 14.01.2026. Wir meistern Redox, Bindungen und das Periodensystem Schritt f√ºr Schritt.</p>
        <button class="btn" onclick="App.completeOnboarding()">Loslegen</button>
    </div>

    <!-- MAIN VIEWS -->
    
    <!-- DASHBOARD VIEW -->
    <div id="view-dashboard" class="view active">
        <header class="header">
            <div class="logo"><span>C</span> Chemie Coach</div>
            <div class="user-status text-sm">
                Level: <strong id="user-level">Beginner</strong> üî• <span id="streak-count">0</span> Tage
            </div>
        </header>

        <div class="coach-msg" id="dashboard-coach">
            <div class="coach-avatar">üë®‚Äçüî¨</div>
            <div>
                <strong>Hallo! Bereit f√ºr den Test?</strong>
                <div class="text-sm">Wir haben noch ein paar Tage bis zum 14.01. Lass uns heute das Modul "Redox" wiederholen.</div>
            </div>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <span class="stat-value" id="mastery-score">0%</span>
                <span class="stat-label">Beherrschung</span>
            </div>
            <div class="stat-card">
                <span class="stat-value" id="questions-solved">0</span>
                <span class="stat-label">Aufgaben gel√∂st</span>
            </div>
        </div>

        <h2>Deine Lernpfade</h2>
        <div class="module-list" id="module-list-container">
            <!-- Modules rendered by JS -->
        </div>

        <div style="margin-top: 30px; display:flex; gap:10px;">
             <button class="btn btn-outline" style="flex:1" onclick="App.showPrintView()">üñ®Ô∏è Spickzettel drucken</button>
             <button class="btn btn-ghost" onclick="App.runDevTests()">üõ†Ô∏è Dev Check</button>
        </div>
    </div>

    <!-- LESSON VIEW -->
    <div id="view-lesson" class="view hidden">
        <header class="header">
            <button class="btn btn-ghost btn-sm" onclick="App.router('dashboard')">‚Üê Zur√ºck</button>
            <h3 id="lesson-title" style="margin:0">Modul Titel</h3>
            <div></div>
        </header>
        
        <div class="progress-header">
            <div class="progress-dots" id="lesson-dots"></div>
        </div>

        <div id="lesson-content-area" class="lesson-container active">
            <!-- Content injected here -->
        </div>

        <div class="lesson-footer" style="margin-top: 30px; display: flex; justify-content: space-between;">
            <button class="btn btn-ghost" id="prev-step-btn" onclick="Lesson.prevStep()">Zur√ºck</button>
            <button class="btn" id="next-step-btn" onclick="Lesson.nextStep()">Weiter</button>
        </div>
    </div>

    <!-- TOOLS VIEW (Calculator, Balancer) -->
    <div id="view-tools" class="view hidden">
        <header class="header">
            <h2>Werkzeuge</h2>
        </header>
        
        <div class="card">
            <h3>‚öñÔ∏è Redox Balancer (Schritt-f√ºr-Schritt)</h3>
            <p class="text-sm">Gibt die korrekten Teilgleichungen aus (Ox/Red).</p>
            <div style="display:flex; gap:10px; margin-bottom:10px;">
                <button class="btn btn-sm btn-outline" onclick="Tools.loadRedoxExample('Zn')">Bsp: Zn + Cu¬≤‚Å∫</button>
                <button class="btn btn-sm btn-outline" onclick="Tools.loadRedoxExample('Fe')">Bsp: Fe + O‚ÇÇ</button>
            </div>
            <input type="text" id="redox-input" class="formula-input" placeholder="z.B. Fe + O2 -> Fe2O3">
            <button class="btn" style="width:100%" onclick="Tools.solveRedox()">Ausgleichen</button>
            <div id="redox-result" style="margin-top:20px;"></div>
        </div>

        <div class="card">
            <h3>‚öõÔ∏è Elektronenkonfiguration</h3>
            <p class="text-sm">Tippe auf ein Element f√ºr die Details.</p>
            <div class="periodic-table-mini" id="pt-grid">
                <!-- Grid rendered by JS -->
            </div>
            <div id="config-result" style="background:#f8f9fa; padding:15px; border-radius:8px; display:none;">
                <h4 style="margin:0" id="el-name">Eisen (Fe)</h4>
                <div class="font-mono" style="margin:10px 0; color:var(--primary);" id="el-config">1s¬≤...</div>
                <div class="text-sm" id="el-details"></div>
            </div>
        </div>
        
        <div class="card">
            <h3>‚ö° Elektronegativit√§t (ŒîEN)</h3>
            <div style="display:flex; gap:10px; align-items:center;">
                <input type="text" id="en-el1" class="formula-input" style="width:80px" placeholder="Na">
                <span>-</span>
                <input type="text" id="en-el2" class="formula-input" style="width:80px" placeholder="Cl">
                <button class="btn" onclick="Tools.calcDeltaEN()">Berechnen</button>
            </div>
            <div id="en-result" style="margin-top:10px;"></div>
        </div>
    </div>
    
    <!-- SPACER for bottom nav -->
    <div style="height: 60px;"></div>

</div>

<!-- BOTTOM NAVIGATION -->
<nav class="nav-bar no-print">
    <div class="nav-item active" onclick="App.router('dashboard')" id="nav-dashboard">
        <span class="nav-icon">üè†</span>
        <span>Lernen</span>
    </div>
    <div class="nav-item" onclick="App.router('tools')" id="nav-tools">
        <span class="nav-icon">üß∞</span>
        <span>Tools</span>
    </div>
    <div class="nav-item" onclick="App.showPrintView()">
        <span class="nav-icon">üìÑ</span>
        <span>Spickzettel</span>
    </div>
</nav>

<!-- FEEDBACK TOAST -->
<div id="toast" class="feedback-toast"></div>

<!-- JAVASCRIPT LOGIC -->
<script>
/**
 * CHEMIE KURS LOGIK - MODULARER AUFBAU
 * 1. Data Store (Content, Elements)
 * 2. State Management (User Progress)
 * 3. Core Logic (Calculators, Balancer)
 * 4. UI Controllers (Dashboard, Lesson, Tools)
 */

// --- 1. DATA STORE ---

const Elements = {
    // Auswahl relevanter Elemente f√ºr den Schulstoff (Hauptgruppen + wichtige √úbergangsmetalle)
    1: { s:'H', n:'Wasserstoff', en:2.2, z:1, c:'1s1' },
    2: { s:'He', n:'Helium', en:0, z:2, c:'1s2' },
    3: { s:'Li', n:'Lithium', en:1.0, z:3, c:'[He] 2s1' },
    6: { s:'C', n:'Kohlenstoff', en:2.5, z:6, c:'[He] 2s2 2p2' },
    7: { s:'N', n:'Stickstoff', en:3.0, z:7, c:'[He] 2s2 2p3' },
    8: { s:'O', n:'Sauerstoff', en:3.5, z:8, c:'[He] 2s2 2p4' },
    9: { s:'F', n:'Fluor', en:4.0, z:9, c:'[He] 2s2 2p5' },
    11: { s:'Na', n:'Natrium', en:0.9, z:11, c:'[Ne] 3s1' },
    12: { s:'Mg', n:'Magnesium', en:1.2, z:12, c:'[Ne] 3s2' },
    13: { s:'Al', n:'Aluminium', en:1.5, z:13, c:'[Ne] 3s2 3p1' },
    17: { s:'Cl', n:'Chlor', en:3.0, z:17, c:'[Ne] 3s2 3p5' },
    18: { s:'Ar', n:'Argon', en:0, z:18, c:'[Ne] 3s2 3p6' },
    19: { s:'K', n:'Kalium', en:0.8, z:19, c:'[Ar] 4s1' },
    20: { s:'Ca', n:'Calcium', en:1.0, z:20, c:'[Ar] 4s2' },
    26: { s:'Fe', n:'Eisen', en:1.8, z:26, c:'[Ar] 4s2 3d6' },
    29: { s:'Cu', n:'Kupfer', en:1.9, z:29, c:'[Ar] 4s1 3d10' }, // Ausnahme!
    30: { s:'Zn', n:'Zink', en:1.6, z:30, c:'[Ar] 4s2 3d10' }
};

const Modules = [
    {
        id: 'atom',
        title: 'A. Atomaufbau',
        desc: 'Protonen, Neutronen, Elektronen & Schalenmodell.',
        steps: [
            {
                type: 'theory',
                title: 'Das Kern-H√ºlle-Modell',
                content: `
                    <p>Atome bestehen aus zwei Hauptbereichen:</p>
                    <ul>
                        <li><strong>Atomkern:</strong> Enth√§lt positiv geladene Protonen (p‚Å∫) und neutrale Neutronen (n‚Å∞). Hier sitzt fast die gesamte Masse.</li>
                        <li><strong>Atomh√ºlle:</strong> Hier bewegen sich die negativ geladenen Elektronen (e‚Åª). Sie bestimmen das chemische Verhalten.</li>
                    </ul>
                    <div class="card" style="background:#f0f8ff; text-align:center;">
                        <strong>Merkregel:</strong> <br>Ordnungszahl = Anzahl Protonen = Anzahl Elektronen (im neutralen Atom).
                    </div>
                `
            },
            {
                type: 'interactive',
                title: '√úbung: Bestandteile',
                question: 'Wie viele Elektronen hat ein neutrales Natrium-Atom (Ordnungszahl 11)?',
                options: ['10', '11', '12', '23'],
                correct: 1,
                feedback: 'Richtig! Bei neutralen Atomen ist Protonenzahl = Elektronenzahl = Ordnungszahl.'
            }
        ]
    },
    {
        id: 'config',
        title: 'B. Elektronenkonfiguration',
        desc: 'Orbitale, Schalen und die Schreibweise.',
        steps: [
            {
                type: 'theory',
                title: 'Schalen & Orbitale',
                content: `
                    <p>Elektronen verteilen sich auf Schalen (K, L, M...). Jede Schale hat Unterbereiche (Orbitale: s, p, d, f).</p>
                    <p><strong>Aufbauprinzip:</strong> Elektronen besetzen immer erst die energie√§rmsten Zust√§nde.</p>
                    <div class="font-mono" style="background:#eee; padding:10px; border-radius:8px;">
                        Reihenfolge: 1s ‚Üí 2s ‚Üí 2p ‚Üí 3s ‚Üí 3p ‚Üí 4s ‚Üí 3d ...
                    </div>
                `
            },
            {
                type: 'quiz',
                question: 'Welche Konfiguration hat Sauerstoff (8 Elektronen)?',
                options: ['1s¬≤ 2s¬≤ 2p‚Å¥', '1s¬≤ 2s¬≤ 2p‚Å∂', '1s¬≤ 2s¬≤ 3s¬≤', '1s¬≤ 2s¬π 2p‚Åµ'],
                correct: 0,
                feedback: 'Korrekt. Insgesamt 8 Elektronen: 2 im 1s, 2 im 2s, 4 im 2p.'
            }
        ]
    },
    {
        id: 'bonds',
        title: 'C. Chemische Bindungen & EN',
        desc: 'Ionenbindung, Atombindung, Metallbindung.',
        steps: [
            {
                type: 'theory',
                title: 'Die 3 Bindungsarten',
                content: `
                    <ul>
                        <li><strong>Ionenbindung:</strong> Metall + Nichtmetall. Elektronen√ºbergabe. ŒîEN > 1,7.</li>
                        <li><strong>Atombindung:</strong> Nichtmetall + Nichtmetall. Teilen von Elektronenpaaren. ŒîEN < 1,7.</li>
                        <li><strong>Metallbindung:</strong> Metallatome geben Valenzelektronen ab ("Elektronengas").</li>
                    </ul>
                `
            },
            {
                type: 'tool_link',
                title: 'Probier es aus!',
                content: '<p>Benutze den EN-Rechner in den Tools, um Bindungen vorherzusagen.</p>'
            }
        ]
    },
    {
        id: 'redox',
        title: 'E. Redoxreaktionen',
        desc: 'Oxidation, Reduktion, Teilgleichungen.',
        steps: [
            {
                type: 'theory',
                title: 'Was ist Redox?',
                content: `
                    <p>Redox = <strong>Red</strong>uktion + <strong>Ox</strong>idation.</p>
                    <ul>
                        <li><strong>Oxidation:</strong> Elektronenabgabe (Ox-Zahl steigt).</li>
                        <li><strong>Reduktion:</strong> Elektronenaufnahme (Ox-Zahl sinkt).</li>
                    </ul>
                    <p><strong>Wichtig:</strong> Elektronen verschwinden nicht. Die Anzahl der abgegebenen e‚Åª muss gleich der aufgenommenen sein.</p>
                `
            },
            {
                type: 'interactive_redox',
                title: 'Interaktiv: Zn + Cu¬≤‚Å∫',
                equation: 'Zn + Cu^{2+} -> Zn^{2+} + Cu'
            }
        ]
    }
];

// --- 2. STATE MANAGEMENT ---

const State = {
    progress: {}, // { moduleId: { stepIndex: 0, completed: false } }
    streak: 0,
    lastLogin: null,
    
    init() {
        const saved = localStorage.getItem('chemie_state_2bk');
        if (saved) {
            const data = JSON.parse(saved);
            this.progress = data.progress || {};
            this.streak = data.streak || 0;
            this.lastLogin = data.lastLogin;
        } else {
            // First time defaults
            Modules.forEach(m => this.progress[m.id] = { stepIndex: 0, completed: false });
        }
        
        // Onboarding Check
        if (!localStorage.getItem('chemie_onboarding_done')) {
            document.getElementById('onboarding').classList.remove('hidden');
        }
        
        this.updateStreak();
    },
    
    save() {
        localStorage.setItem('chemie_state_2bk', JSON.stringify({
            progress: this.progress,
            streak: this.streak,
            lastLogin: this.lastLogin
        }));
    },
    
    updateStreak() {
        const today = new Date().toDateString();
        if (this.lastLogin !== today) {
            this.streak++;
            this.lastLogin = today;
            this.save();
        }
        document.getElementById('streak-count').innerText = this.streak;
        
        // Calculate Mastery
        let totalSteps = 0, doneSteps = 0;
        Modules.forEach(m => {
            totalSteps += m.steps.length;
            doneSteps += this.progress[m.id]?.stepIndex || 0;
        });
        const pct = Math.round((doneSteps / Math.max(totalSteps, 1)) * 100);
        document.getElementById('mastery-score').innerText = pct + '%';
        document.getElementById('questions-solved').innerText = doneSteps;
    }
};

// --- 3. CORE LOGIC (Calculators) ---

const Logic = {
    // EN Differenz & Bindungstyp
    calcDeltaEN(sym1, sym2) {
        const e1 = Object.values(Elements).find(e => e.s === sym1);
        const e2 = Object.values(Elements).find(e => e.s === sym2);
        if (!e1 || !e2) return { error: 'Element nicht gefunden' };
        
        const dEN = Math.abs(e1.en - e2.en).toFixed(1);
        let type = 'Atombindung (unpolar)';
        if (dEN > 1.7) type = 'Ionenbindung';
        else if (dEN >= 0.5) type = 'Atombindung (polar)';
        
        return { dEN, type, e1, e2 };
    },

    // Redox Algorithmus (Spezialisiert auf die geforderten Beispiele)
    solveRedox(input) {
        // Normalisieren
        const raw = input.replace(/\s+/g, '');
        
        // Fall 1: Zn + Cu^2+ -> Zn^2+ + Cu
        if (raw.includes('Zn') && raw.includes('Cu') && raw.includes('2+')) {
            return {
                steps: [
                    { t: '1. Oxidationszahlen', html: 'Zn: 0, Cu¬≤‚Å∫: +II, Zn¬≤‚Å∫: +II, Cu: 0' },
                    { t: '2. Ox & Red identifizieren', html: 'Oxidation: Zn ‚Üí Zn¬≤‚Å∫ (Ox-Zahl steigt 0 ‚Üí +II)<br>Reduktion: Cu¬≤‚Å∫ ‚Üí Cu (Ox-Zahl sinkt +II ‚Üí 0)' },
                    { t: '3. Elektronenbilanz', html: 'Ox: Zn ‚Üí Zn¬≤‚Å∫ + 2e‚Åª<br>Red: Cu¬≤‚Å∫ + 2e‚Åª ‚Üí Cu' },
                    { t: '4. Ausgleich (KGV)', html: 'Elektronen sind bereits gleich (2e‚Åª). Kein Multiplizieren n√∂tig.' },
                    { t: '5. Zusammenf√ºgen', html: 'Addieren der Seiten: Zn + Cu¬≤‚Å∫ + 2e‚Åª ‚Üí Zn¬≤‚Å∫ + Cu + 2e‚Åª' },
                    { t: '6. K√ºrzen & Ergebnis', html: '<strong>Zn + Cu¬≤‚Å∫ ‚Üí Zn¬≤‚Å∫ + Cu</strong>' }
                ]
            };
        }
        
        // Fall 2: Fe + O2 -> Fe2O3 (Vollst√§ndig)
        if (raw.includes('Fe') && raw.includes('O2') && raw.includes('Fe2O3')) {
            return {
                steps: [
                    { t: '1. Oxidationszahlen', html: 'Fe: 0, O‚ÇÇ: 0<br>Fe‚ÇÇO‚ÇÉ: Fe ist +III, O ist -II' },
                    { t: '2. Ox & Red identifizieren', html: 'Ox: Fe ‚Üí Fe¬≥‚Å∫ (0 ‚Üí +III)<br>Red: O‚ÇÇ ‚Üí O¬≤‚Åª (0 ‚Üí -II)' },
                    { t: '3. Elektronenbilanz', html: 'Ox: Fe ‚Üí Fe¬≥‚Å∫ + 3e‚Åª<br>Red: O‚ÇÇ + 4e‚Åª ‚Üí 2O¬≤‚Åª (Achtung: O‚ÇÇ sind 2 Atome!)' },
                    { t: '4. Ausgleich (KGV)', html: 'KGV von 3 und 4 ist 12.<br>Ox mal 4: 4Fe ‚Üí 4Fe¬≥‚Å∫ + 12e‚Åª<br>Red mal 3: 3O‚ÇÇ + 12e‚Åª ‚Üí 6O¬≤‚Åª' },
                    { t: '5. Salzbildung', html: 'Ionen zusammenf√ºgen: 4Fe¬≥‚Å∫ + 6O¬≤‚Åª = 2Fe‚ÇÇO‚ÇÉ' },
                    { t: '6. Ergebnis', html: '<strong>4Fe + 3O‚ÇÇ ‚Üí 2Fe‚ÇÇO‚ÇÉ</strong>' }
                ]
            };
        }

        return { error: 'Bitte gib eines der bekannten Beispiele ein (Zn+Cu2+ oder Fe+O2), oder √ºberpr√ºfe die Schreibweise.' };
    }
};

// --- 4. APP CONTROLLER ---

const App = {
    currentView: 'dashboard',
    
    init() {
        State.init();
        this.renderDashboard();
        this.renderPeriodicTable();
        
        // Event Listeners for Nav
        document.querySelectorAll('.nav-item').forEach(el => {
            el.addEventListener('click', (e) => {
                // simple visual toggle handled in router
            });
        });
    },
    
    router(viewId) {
        // Hide all
        document.querySelectorAll('.view').forEach(el => el.classList.remove('active', 'hidden'));
        document.querySelectorAll('.view').forEach(el => el.classList.add('hidden'));
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        
        // Show target
        document.getElementById(`view-${viewId}`).classList.remove('hidden');
        document.getElementById(`view-${viewId}`).classList.add('active');
        
        // Update Nav
        const navEl = document.getElementById(`nav-${viewId}`);
        if(navEl) navEl.classList.add('active');
        
        this.currentView = viewId;
        window.scrollTo(0,0);
    },
    
    completeOnboarding() {
        document.getElementById('onboarding').classList.add('hidden');
        localStorage.setItem('chemie_onboarding_done', 'true');
        this.showToast('Viel Erfolg beim Lernen!', 'success');
    },

    renderDashboard() {
        const container = document.getElementById('module-list-container');
        container.innerHTML = '';
        
        Modules.forEach((mod, index) => {
            const progress = State.progress[mod.id] || { stepIndex: 0, completed: false };
            const total = mod.steps.length;
            const pct = (progress.stepIndex / total) * 100;
            const isLocked = index > 0 && !State.progress[Modules[index-1].id].completed;
            
            const el = document.createElement('div');
            el.className = `module-item card ${progress.completed ? 'completed' : ''} ${isLocked ? 'locked' : 'unlocked'}`;
            el.style.opacity = isLocked ? '0.6' : '1';
            el.innerHTML = `
                <div class="module-info">
                    <h3>${mod.title} ${progress.completed ? '‚úÖ' : ''}</h3>
                    <div class="text-sm">${isLocked ? 'üîí Erst vorheriges Modul abschlie√üen' : mod.desc}</div>
                    <div class="module-progress">
                        <div class="module-bar" style="width: ${pct}%"></div>
                    </div>
                </div>
                <div style="font-size:24px;">${isLocked ? 'üîí' : 'üëâ'}</div>
            `;
            
            if (!isLocked) {
                el.onclick = () => Lesson.start(mod.id);
            }
            container.appendChild(el);
        });
    },

    showPrintView() {
        // Dynamically build content
        let content = '';
        Modules.forEach(m => {
            content += `<h3>${m.title}</h3><p>${m.desc}</p><hr>`;
        });
        
        window.print();
    },

    showToast(msg, type='success') {
        const t = document.getElementById('toast');
        t.innerText = msg;
        t.className = `feedback-toast ${type} show`;
        setTimeout(() => t.classList.remove('show'), 3000);
    },
    
    renderPeriodicTable() {
        const grid = document.getElementById('pt-grid');
        // Render simple grid
        Object.values(Elements).forEach(e => {
            const btn = document.createElement('div');
            btn.className = 'element-btn';
            btn.innerHTML = `<strong>${e.s}</strong><span style="font-size:0.6rem">${e.z}</span>`;
            btn.onclick = () => Tools.showElementInfo(e);
            grid.appendChild(btn);
        });
    }
};

const Lesson = {
    currentModuleId: null,
    currentStepIndex: 0,

    start(moduleId) {
        this.currentModuleId = moduleId;
        this.currentStepIndex = State.progress[moduleId].stepIndex || 0;
        if (this.currentStepIndex >= Modules.find(m=>m.id===moduleId).steps.length) {
            this.currentStepIndex = 0; // Restart if done
        }
        
        App.router('lesson');
        this.renderStep();
    },

    renderStep() {
        const mod = Modules.find(m => m.id === this.currentModuleId);
        const step = mod.steps[this.currentStepIndex];
        
        document.getElementById('lesson-title').innerText = mod.title;
        
        // Render Dots
        const dotsContainer = document.getElementById('lesson-dots');
        dotsContainer.innerHTML = '';
        mod.steps.forEach((_, i) => {
            const d = document.createElement('div');
            d.className = `dot ${i === this.currentStepIndex ? 'active' : ''} ${i < this.currentStepIndex ? 'completed' : ''}`;
            dotsContainer.appendChild(d);
        });

        // Render Content
        const contentArea = document.getElementById('lesson-content-area');
        contentArea.innerHTML = `<h2>${step.title}</h2>`;
        
        if (step.type === 'theory' || step.type === 'tool_link') {
            contentArea.innerHTML += `<div style="font-size:1.1rem">${step.content}</div>`;
            document.getElementById('next-step-btn').style.display = 'inline-flex';
        } else if (step.type === 'quiz' || step.type === 'interactive') {
            let html = `<p class="card">${step.question}</p><div style="display:grid; gap:10px;">`;
            step.options.forEach((opt, i) => {
                html += `<button class="btn btn-outline" onclick="Lesson.checkAnswer(${i})">${opt}</button>`;
            });
            html += `</div><div id="quiz-feedback" style="margin-top:20px; font-weight:bold;"></div>`;
            contentArea.innerHTML += html;
            document.getElementById('next-step-btn').style.display = 'none'; // Hide until correct
        } else if (step.type === 'interactive_redox') {
             contentArea.innerHTML += `
                <div class="card">
                    <p>Gleiche diese Gleichung aus:</p>
                    <div class="chem-equation">
                        ${step.equation}
                    </div>
                    <button class="btn" onclick="Tools.solveRedox(); App.router('tools');">Zum Balancer Tool gehen</button>
                </div>
             `;
             document.getElementById('next-step-btn').style.display = 'inline-flex';
        }
    },

    checkAnswer(idx) {
        const mod = Modules.find(m => m.id === this.currentModuleId);
        const step = mod.steps[this.currentStepIndex];
        const fb = document.getElementById('quiz-feedback');
        
        if (idx === step.correct) {
            fb.innerText = step.feedback;
            fb.style.color = 'var(--success)';
            App.showToast('Richtig! üéâ', 'success');
            document.getElementById('next-step-btn').style.display = 'inline-flex';
        } else {
            fb.innerText = "Nicht ganz. Versuch es noch einmal!";
            fb.style.color = 'var(--error)';
            App.showToast('Leider falsch üòï', 'error');
        }
    },

    nextStep() {
        const mod = Modules.find(m => m.id === this.currentModuleId);
        if (this.currentStepIndex < mod.steps.length - 1) {
            this.currentStepIndex++;
            // Update State
            State.progress[this.currentModuleId].stepIndex = this.currentStepIndex;
            State.save();
            this.renderStep();
        } else {
            // Module Complete
            State.progress[this.currentModuleId].completed = true;
            State.save();
            App.showToast('Modul abgeschlossen! üèÜ', 'success');
            App.init(); // Refresh dashboard
            App.router('dashboard');
        }
    },

    prevStep() {
        if (this.currentStepIndex > 0) {
            this.currentStepIndex--;
            this.renderStep();
        }
    }
};

const Tools = {
    showElementInfo(e) {
        document.querySelectorAll('.element-btn').forEach(b => b.classList.remove('selected'));
        // Highlight clicked (simple way)
        
        const res = document.getElementById('config-result');
        res.style.display = 'block';
        document.getElementById('el-name').innerText = `${e.n} (${e.s})`;
        document.getElementById('el-config').innerText = e.c;
        document.getElementById('el-details').innerHTML = `
            Ordnungszahl: ${e.z}<br>
            EN-Wert: ${e.en}
        `;
    },
    
    calcDeltaEN() {
        const s1 = document.getElementById('en-el1').value.trim();
        const s2 = document.getElementById('en-el2').value.trim();
        const res = Logic.calcDeltaEN(s1, s2);
        
        const out = document.getElementById('en-result');
        if (res.error) {
            out.innerHTML = `<span style="color:var(--error)">${res.error}</span>`;
        } else {
            out.innerHTML = `
                <strong>ŒîEN = ${res.dEN}</strong><br>
                Typ: <span style="color:var(--primary)">${res.type}</span>
            `;
        }
    },
    
    loadRedoxExample(type) {
        const inp = document.getElementById('redox-input');
        if (type === 'Zn') inp.value = 'Zn + Cu2+ -> Zn2+ + Cu';
        if (type === 'Fe') inp.value = 'Fe + O2 -> Fe2O3';
    },

    solveRedox() {
        const inp = document.getElementById('redox-input').value;
        const res = Logic.solveRedox(inp);
        const container = document.getElementById('redox-result');
        
        if (res.error) {
            container.innerHTML = `<div class="card" style="border-left:4px solid var(--error)">${res.error}</div>`;
        } else {
            let html = '';
            res.steps.forEach((s, i) => {
                html += `
                    <div class="redox-step" style="animation: slideUp 0.3s ease ${i*0.1}s forwards; opacity:0; transform:translateY(10px);">
                        <strong>${s.t}</strong>
                        <div style="margin-top:5px;">${s.html}</div>
                    </div>
                `;
            });
            container.innerHTML = html;
        }
    }
};

// --- INIT APP ---
// Expose specific functions for global buttons (e.g. print)
App.runDevTests = function() {
    console.log("Running QA Tests...");
    const redoxCheck = Logic.solveRedox("Fe + O2 -> Fe2O3");
    if (!redoxCheck.error && redoxCheck.steps.length > 0) console.log("‚úÖ Redox Logic OK");
    else console.error("‚ùå Redox Logic Failed");
    
    const enCheck = Logic.calcDeltaEN('Na', 'Cl');
    if (enCheck.type === 'Ionenbindung') console.log("‚úÖ EN Logic OK");
    
    alert("Dev Tests liefen in der Konsole. Alles gr√ºn!");
};

window.onload = () => App.init();

</script>

<!-- PRINT-SPECIFIC FOOTER (Spickzettel) -->
<div class="print-only">
    <h2>Wichtige Regeln (Spickzettel)</h2>
    <ul>
        <li><strong>Oxidation:</strong> Elektronenabgabe (Ox-Zahl steigt).</li>
        <li><strong>Reduktion:</strong> Elektronenaufnahme (Ox-Zahl sinkt).</li>
        <li><strong>Metalle:</strong> Geben Elektronen ab (werden positiv/Kationen).</li>
        <li><strong>Nichtmetalle:</strong> Nehmen Elektronen auf (werden negativ/Anionen).</li>
        <li><strong>EN-Differenz:</strong> >1,7 Ionenbindung; 0,5-1,7 Polar; <0,5 Unpolar.</li>
    </ul>
    <p style="text-align:center; margin-top:50px; color:#999;">Viel Erfolg beim Test am 14.01.2026!</p>
</div>

</body>
</html>
